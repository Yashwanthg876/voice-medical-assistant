<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice-Controlled Medical Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #eef2f3;
            padding: 20px;
            font-size: 18px;
        }

        h1 {
            text-align: center;
            color: #1f2d3d;
            font-size: 32px;
        }

        h2 {
            font-size: 26px;
            color: #2c3e50;
        }

        .section {
            background: #ffffff;
            padding: 25px;
            margin: 25px auto;
            border-radius: 10px;
            max-width: 650px;
            box-shadow: 0 0 12px rgba(0,0,0,0.15);
        }

        p {
            font-size: 20px;
            color: #333;
        }

        button {
            width: 100%;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .emergency-btn {
            background-color: #d9534f;
        }

        .emergency-btn:hover {
            background-color: #c9302c;
        }

        input[type="file"] {
            font-size: 18px;
            margin-top: 15px;
        }

        .output {
            margin-top: 20px;
            font-size: 22px;
            color: #1f2d3d;
        }

        .intent {
            font-weight: bold;
            margin-top: 10px;
        }

        .emergency {
            color: red;
            font-size: 24px;
        }

        .confidence {
            font-size: 20px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>ü©∫ Voice-Controlled Medical Assistant</h1>

<!-- ========== VOICE SECTION ========== -->
<div class="section">
    <h2>üéô Speak to the Assistant</h2>
    <p>
        Press the button and speak clearly.<br>
        Example: <b>"I feel dizzy"</b>
    </p>

    <button onclick="recordVoice()">üé§ START SPEAKING</button>

    <div class="output" id="voiceResult"></div>
</div>

<!-- ========== IMAGE SECTION ========== -->
<div class="section">
    <h2>üñº Medical Image Check</h2>
    <p>
        Upload an X-ray or scan image and press analyze.
    </p>

    <input type="file" id="imageInput">
    <br><br>

    <button onclick="uploadImage()">üß™ ANALYZE IMAGE</button>

    <div class="output" id="imageResult"></div>
</div>

<script>
/* ========== VOICE RECORDING ========== */
function recordVoice() {
    document.getElementById("voiceResult").innerHTML =
        "üéß Listening... Please speak now.";

    navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
        const mediaRecorder = new MediaRecorder(stream);
        let chunks = [];

        mediaRecorder.start();

        mediaRecorder.ondataavailable = e => {
            chunks.push(e.data);
        };

        setTimeout(() => {
            mediaRecorder.stop();

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: "audio/webm" });
                const formData = new FormData();
                formData.append("audio", blob, "voice.webm");

                fetch("/upload_audio", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    let intentStyle = data.intent === "EMERGENCY"
                        ? "emergency"
                        : "intent";

                    document.getElementById("voiceResult").innerHTML =
                        "<b>You said:</b> " + data.text + "<br>" +
                        "<span class='" + intentStyle + "'>" +
                        "Detected intent: " + data.intent +
                        "</span>";
                })
                .catch(() => {
                    document.getElementById("voiceResult").innerText =
                        "‚ùå Could not process voice input";
                });
            };
        }, 4000);
    })
    .catch(() => {
        document.getElementById("voiceResult").innerText =
            "‚ùå Microphone access denied";
    });
}

/* ========== IMAGE UPLOAD ========== */
function uploadImage() {
    const imageInput = document.getElementById("imageInput");

    if (imageInput.files.length === 0) {
        alert("Please choose an image first");
        return;
    }

    document.getElementById("imageResult").innerHTML =
        "üîç Analyzing image... Please wait.";

    const formData = new FormData();
    formData.append("image", imageInput.files[0]);

    fetch("/upload_image", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("imageResult").innerHTML =
            "<b>Result:</b> " + data.prediction + "<br>" +
            "<span class='confidence'>" +
            "Confidence: " + (data.confidence * 100).toFixed(1) + "%" +
            "</span>";
    })
    .catch(() => {
        document.getElementById("imageResult").innerText =
            "‚ùå Image analysis failed";
    });
}
</script>

</body>
</html>