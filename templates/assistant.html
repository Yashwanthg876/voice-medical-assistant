{% extends "base.html" %}
{% block content %}

<div class="card" style="text-align:center;">
    <h2 class="title">Voice Medical Assistant</h2>
    <p class="subtitle">
        Speak naturally. The AI will analyze symptoms and detect medical intent.
    </p>

    <div id="assistantStatus"
         style="margin:25px auto; padding:14px 24px;
                display:inline-block;
                border-radius:999px;
                background:#dbeafe;
                color:#1e3a8a;
                font-weight:600;">
        Idle
    </div>

    <div style="margin-top:30px;">
        <button class="btn btn-primary" onclick="startRecording()">ğŸ™ Start Listening</button>
        <button class="btn btn-danger" onclick="stopRecording()" style="margin-left:15px;">
            â¹ Stop
        </button>
    </div>
</div>

<div class="card">
    <h3 class="title" style="font-size:22px;">Analysis Result</h3>

    <div style="margin-top:20px;">
        <p class="subtitle"><strong>ğŸ“ Transcribed Text</strong></p>
        <p id="transcribedText">â€”</p>
    </div>

    <hr style="margin:25px 0; border:none; border-top:1px solid #e2e8f0;">

    <div>
        <p class="subtitle"><strong>ğŸ¯ Detected Intent</strong></p>
        <p id="detectedIntent">â€”</p>
    </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];

const statusEl = document.getElementById("assistantStatus");
const textEl = document.getElementById("transcribedText");
const intentEl = document.getElementById("detectedIntent");

async function startRecording() {
    audioChunks = [];
    statusEl.innerText = "Listening...";

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
        statusEl.innerText = "Processing...";
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob);

        try {
            const res = await fetch("/upload_audio", {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            textEl.innerText = data.text || "â€”";
            intentEl.innerText = data.intent || "â€”";
            statusEl.innerText = "Completed";

        } catch (err) {
            statusEl.innerText = "Error";
        }
    };

    mediaRecorder.start();
}

function stopRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
    }
}
</script>

{% endblock %}